<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>
	<!-- Disable until post message received -->
	<button onclick="openNewTab()">Open up</button>
	<button onclick="closeAllTabs()">Close all</button>
	<button onclick="showList()">Show list</button>

	<br /><br />
	<div>All tabs Info Below</div>
	<div id="list"></div>

	<br /><br />
	<div>All Post Messages Info Below</div>
	<div id="pm"></div>

	<script type="text/javascript">
		window.childTabs = [];

		/*
		 * TABS Class
		 */
		function Tabs() {
			this.tabs = [];
		}
		Tabs.prototype.addNew = function (tab) {
			this.tabs.push(tab);
			window.childTabs.push({
				id: tab.id,
				name: tab.name
			});
			return this;
		};
		Tabs.prototype.getAllTabs = function () {
			return this.tabs;
		};

		/*
		 * TAB Class
		 */
		function Tab() {

		}
		Tab.prototype = new Tabs(); // Inheritance
		Tab.prototype.create = function () {
			this.id = (tabs.tabs.length + 100) || 100;
			this.name = (tabs.tabs.length + 100) || 100;
			this.status = 'open';
			this.ref =  window.open('/child.html', '_blank');
			window.newlyTabOpened = {
				id: this.id,
				name: this.name
			}

			tabs.addNew(this);

			return this; // for chaining
		};
		Tab.prototype.getAll = function () {
			return tabs.getAllTabs();
		};

	</script>
	<script type="text/javascript">

		function showPMList (data) {
			document.getElementById('pm').innerHTML += '<li>data recieved by tab: ' + data + '</li>';
		}

		function onNewTabPostMessage (message) {
			var data = message.data;
			showPMList(data);
		}
		window.removeEventListener('message', onNewTabPostMessage);
		window.addEventListener('message', onNewTabPostMessage);
	</script>
	<script type="text/javascript">
		window.name = 'MASTER_TAB';

		var tabs = new Tabs();
		var tab;

		function openNewTab () {
			tab = new Tab();
			tab.create();
			console.log( tab )
		}

		function closeAllTabs () {
			var tabs = tab.getAll();
			for (var i = 0; i < tabs.length; i++) {
				tabs[i].ref.close();
			}
		}

		function showList () {
			if (!tab) { return; }

			var list = '';
			var tabs = tab.getAll();

			document.getElementById('list').innerHTML = '';
			for (var i = 0; i < tabs.length; i++) {
				list += '<li>id: ' + tabs[i].id + ' name: ' + tabs[i].name + ' status: ' + tabs[i].status + '</li>';
			}
			document.getElementById('list').innerHTML = list;
		}

		// don't poll if all tabs are in closed states
		setInterval(function () {
			if (!tab) { return; }

			var tabs = tab.getAll();
			for (var i = 0; i < tabs.length; i++) {
				tabs[i].status = tabs[i].ref.closed ? 'close' : 'open';
			}

			showList();
		}, 500);

	</script>
</body>
</html>